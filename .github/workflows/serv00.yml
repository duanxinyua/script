name: Run SSH Command

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # 每小时执行一次

jobs:
  run-ssh-command:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 jq
        run: sudo apt-get install -y jq

      - name: 解析 ACCOUNTS_JSON 并存入环境变量
        env:
          ACCOUNTS_JSON: ${{ secrets.ACCOUNTS_JSON }}
        run: |
          echo "$ACCOUNTS_JSON" > accounts.json
          echo "ACCOUNTS=$(jq -c . accounts.json)" >> $GITHUB_ENV

      - name: 安装 sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: 通过 SSH 连接并执行命令
        run: |
          set +e
          echo "$ACCOUNTS" | jq -c '.[]' | while read -r account; do
            username=$(echo "$account" | jq -r '.username')
            password=$(echo "$account" | jq -r '.password')
            ssh_host=$(echo "$account" | jq -r '.ssh')

            echo "连接到 $ssh_host，用户 $username"

            output=$(sshpass -p "$password" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $username@$ssh_host 2>&1)
            if echo "$output" | grep -q "ACCOUNT HAS BEEN BLOCKED"; then
              echo "账号 $username 被封锁，跳过..."
              continue
            else
              echo "成功连接到 $ssh_host，用户 $username"
              sshpass -p "$password" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $username@$ssh_host \
                "curl -s https://raw.githubusercontent.com/duanxinyua/socks5-for-serv00/main/check_cron.sh | bash"
            fi
          done
          set -e
